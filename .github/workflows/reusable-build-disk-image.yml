---
name: Build Disk Images

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/reusable-build-disk-image.yml"
      - "deployment/**"
  workflow_run:
    workflows: ["Stable Images"]
    types:
      - completed

env:
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Disk Images
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ${{ matrix.platform == 'amd64' && 'ubuntu-24.04' }}
    strategy:
      fail-fast: false
      matrix:
        platform: [amd64]
        flavor: ["main", "smartboard"]
        image_version: ["stable"]
    permissions:
      contents: read
      packages: read
      id-token: write

    steps:
      - name: Maximize build space
        if: matrix.platform != 'arm64'
        uses: ublue-os/remove-unwanted-software@695eb75bc387dbcd9685a8e72d23439d8686cba6 # v10

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Check Just Syntax
        shell: bash
        run: |
          just check

      - name: Format image ref
        id: image_ref
        env:
          FLAVOR: ${{ matrix.flavor }}
        run: |
          set -eoux pipefail
          image_name=$(just image_name "tholdyos-ad" "${{ matrix.image_version }}" "${{ matrix.flavor }}")
          image_ref="${IMAGE_REGISTRY}/${image_name}"
          BUILD_DATE=$(date +%Y%m%d)
          echo "image_name=$image_name" >> "${GITHUB_OUTPUT}"
          echo "image_ref=$image_ref" >> "${GITHUB_OUTPUT}"
          echo "artifact_format=${image_name}-${{ matrix.image_version }}-${BUILD_DATE}" >> "${GITHUB_OUTPUT}"

      - name: Select BIB config
        id: config
        run: |
          if [[ "${{ matrix.flavor }}" == "smartboard" ]]; then
            echo "config_file=deployment/config-ad-smartboard.toml" >> "${GITHUB_OUTPUT}"
          else
            echo "config_file=deployment/config-ad.toml" >> "${GITHUB_OUTPUT}"
          fi

      - name: Build Disk Image
        id: build
        run: |
          set -eoux pipefail
          mkdir -p output

          sudo podman run \
            --rm \
            --privileged \
            --pull=newer \
            --security-opt label=type:unconfined_t \
            -v ${{ github.workspace }}/${{ steps.config.outputs.config_file }}:/config.toml:ro \
            -v ./output:/output \
            -v /var/lib/containers/storage:/var/lib/containers/storage \
            quay.io/centos-bootc/bootc-image-builder:latest \
            --type raw \
            --rootfs ext4 \
            ${{ steps.image_ref.outputs.image_ref }}:${{ matrix.image_version }}

      - name: Rename and checksum
        id: rename
        env:
          OUTPUT_NAME: ${{ steps.image_ref.outputs.artifact_format }}
        run: |
          set -eoux pipefail
          OUTPUT_DIRECTORY="$(realpath output)"

          # Find the raw disk image
          raw_file=$(find "${OUTPUT_DIRECTORY}" -name "disk.raw" -type f | head -1)
          if [[ -z "${raw_file}" ]]; then
            echo "Error: disk.raw not found in output directory"
            exit 1
          fi

          mv "${raw_file}" "${OUTPUT_DIRECTORY}/${OUTPUT_NAME}.img"
          sha256sum "${OUTPUT_DIRECTORY}/${OUTPUT_NAME}.img" | tee "${OUTPUT_DIRECTORY}/${OUTPUT_NAME}.img-CHECKSUM"

          echo "output_directory=$OUTPUT_DIRECTORY" >> "${GITHUB_OUTPUT}"

      - name: Upload to Job Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: ${{ steps.image_ref.outputs.artifact_format }}
          if-no-files-found: error
          path: ${{ steps.rename.outputs.output_directory }}
