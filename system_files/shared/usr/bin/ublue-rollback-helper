#!/usr/bin/bash

IMAGE_INFO="/usr/share/ublue-os/image-info.json"
IMAGE_NAME=$(jq -r '."image-name"' < "$IMAGE_INFO")
IMAGE_TAG=$(jq -r '."image-tag"' < "$IMAGE_INFO")
IMAGE_VENDOR=$(jq -r '."image-vendor"' < "$IMAGE_INFO")
FEDORA_VERSION=$(jq -r '."fedora-version"' < "$IMAGE_INFO")
IMAGE_REGISTRY="ghcr.io/${IMAGE_VENDOR}"
ROOT_FS=$(findmnt -n -o FSTYPE /)

function list_tags() {
  local filter="$1"
  skopeo list-tags "docker://${IMAGE_REGISTRY}/${IMAGE_NAME}" \
    | jq -r '.Tags[]' \
    | grep -E --color=never "$filter" \
    | sort -rV | head -n 31
}

function rebase_helper() {
  echo "Current image: ${IMAGE_NAME}:${IMAGE_TAG} (Fedora ${FEDORA_VERSION})"
  echo "Root filesystem: ${ROOT_FS}"
  echo

  # Step 1: Base Image
  IMAGE_NAME="$tholdyos"
  base_image="${IMAGE_REGISTRY}/${IMAGE_NAME}"

  # Step 2: Channel
  channel_selected="stable"

  rebase_target="${base_image}:${channel_selected}"

  # Step 3: Date selection (scoped to channel)
  echo "Would you like to pin to a specific build date?"
  echo "NOTICE! You won't receive any updates after pinning to a specific build date."
  date_choice=$(gum choose "no" "yes" "cancel")
  [[ "$date_choice" == "cancel" ]] && return 1

  if [[ "$date_choice" == "yes" ]]; then
    echo "Fetching available tags for channel: $channel_selected..."
    filter="${channel_selected}-[0-9]{8}"

    valid_tags=( $(list_tags "$filter") )
    [[ "${#valid_tags[@]}" -eq 0 ]] && { echo "No tags found for filter: $filter"; return 1; }

    selected_tag=$(gum choose "cancel" "${valid_tags[@]}")
    [[ "$selected_tag" == "cancel" ]] && return 1

    rebase_target="${base_image}:${selected_tag}"
  fi

  echo "Rebase target: ${rebase_target}"
  echo "Confirm rebase?"
  [[ $(gum confirm) -ne 0 ]] && return 1

  if grep -q "^LockLayering=true" /etc/rpm-ostreed.conf; then
    pkexec bootc switch --enforce-container-sigpolicy "${rebase_target}"
  else
    rpm-ostree rebase ostree-image-signed:docker://"${rebase_target}"
  fi
}

echo "Choose your action."
option=$(gum choose "rebase" "cancel")
if [[ "$option" == "rebase" ]]; then
    rebase_helper || /usr/bin/ublue-rollback-helper
else
    exit 0
fi
